<svg xmlns:xlink="http://www.w3.org/1999/xlink" height="804" viewBox="0 0 1132 804" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" width="1132"><style type="text/css"><![CDATA[
.st6 {fill:#00b050;font-family:宋体;font-size:12pt}
.st5 {fill:#118972;font-family:宋体;font-size:12pt}
.st7 {fill:#1f6391;font-family:宋体;font-size:12pt}
.st3 {fill:#555500;font-family:宋体;font-size:12pt}
.st4 {fill:#ff0000}
.st1 {fill:#ffffff;font-family:宋体;font-size:20pt}
.st2 {font-size:12pt}
]]></style><defs/><g id="page1" transform="translate(5,5)"><rect height="794" stroke="#808080" y="0" width="1123" fill="#ffffff" x="0"/><g><g transform="translate(0,759.69)"><path stroke="#527294" d="M0,0L1122.5,0L1122.5,9.4L0,9.4L0,0z" id="shape1" fill="#527294" transform="translate(0,20.79)"/></g><g transform="translate(0,7.56)"><g id="shape2"><path stroke="#527294" d="M0,0L1122.5,0L1122.5,47.2L0,47.2L0,0z" fill="#527294"/><text class="st1"><tspan y="32.1" x="402.4">SCTP四路握手</tspan></text><text class="st1"><tspan class="st2" y="28.1" x="1014.2">2014-6-14</tspan></text></g><path stroke="#ffffff" d="M0,0L3.8,0L3.8,28.3L0,28.3L0,0z" id="shape3" fill="#ffffff" transform="translate(985.93,9.45)"/></g></g><g id="shape4" transform="translate(658.26,69.85)"><text class="st3"><tspan class="st4" y="18" x="4">1</tspan><tspan> 服务器必须准备好接受外来的关联，通常通过调用</tspan><tspan y="37" x="4">socket,bind,listen函数来完成，称为被动打开</tspan><tspan class="st4" y="56" x="4">2</tspan><tspan> 客户通过调用connect或者发送一个隐式打开打开该关</tspan><tspan y="75" x="4">联的消息进行主动打开。这使得客户SCTP发送一个INIT</tspan><tspan y="94" x="4">消息(初始化)，该消息告诉服务器客户的IP地址清单、初</tspan><tspan y="113" x="4">始序列号、用于表示本关联中所有分组的起始标记、客户</tspan><tspan y="132" x="4">请求的外出流的数目及客户能够支持的外来流的数目</tspan><tspan class="st4" y="151" x="4">3</tspan><tspan> 服务器以一个INIT ACK消息确认客户的INIT消息，其</tspan><tspan y="170" x="4">中含有服务器的IP地址清单、初始序列号、起始标记、服</tspan><tspan y="189" x="4">务器请求的外出流的数目、服务器能够支持的外来流的数</tspan><tspan y="208" x="4">目以及一个状态cookie。状态cookie包含服务器用于确信</tspan><tspan y="227" x="4">本关联有效所需的所有状态。它是数字化签名过的，以确</tspan><tspan y="246" x="4">保其有效性</tspan><tspan class="st4" y="265" x="4">4 </tspan><tspan>客户以一个COOKIE ECHO消息回射服务器的状态</tspan><tspan y="284" x="4">cookie。除COOKIE ECHO外，该消息可能在同一个分</tspan><tspan y="303" x="4">组中还捆绑了用户数据</tspan><tspan class="st4" y="322" x="4">5</tspan><tspan> 服务器以一个COOKIE ACK消息确认客户回射的</tspan><tspan y="341" x="4">cookie是正确的，本关联于是建立，该消息也可能在同一</tspan><tspan y="360" x="4">个分组中还捆绑了用户数据。</tspan><tspan y="379" x="4">以上交换至少需要4个分组，故成为四路握手</tspan></text></g><g transform="translate(36.26,63.85)"><g><g transform="translate(106,0)"><g transform="translate(28,33)"><path stroke="#236ea1" d="M0,0L338,0" stroke-width="2" id="shape5" fill="none" transform="matrix(0,1,-1,0,1,2)"/><path stroke="#236ea1" d="M0,0L338,0" stroke-width="2" id="shape6" fill="none" transform="matrix(0,1,-1,0,320,0)"/><g id="shape7" transform="matrix(0.99,0.13,-0.13,0.99,0,46)"><path stroke="#118972" d="M0,0L317.8,0" stroke-width="1.33333" fill="none"/><path stroke="#118972" d="M322.9,0L316.9,-3.5C317.5,-2.4,317.8,-1.3,317.8,0C317.8,1.3,317.5,2.4,316.9,3.5L322.9,0" stroke-width="1" stroke-linecap="round" fill="#118972"/></g><g id="shape8" transform="matrix(-0.99,0.16,-0.16,-0.99,318,99)"><path stroke="#236ea1" d="M0,0L313,0" stroke-width="1.33333" fill="none"/><path stroke="#236ea1" d="M318.1,0L312.1,-3.5C312.7,-2.4,313,-1.3,313,0C313,1.3,312.7,2.4,312.1,3.5L318.1,0" stroke-width="1" stroke-linecap="round" fill="#236ea1"/></g><g id="shape9" transform="matrix(0.99,0.13,-0.13,0.99,6,160)"><path stroke="#118972" d="M0,0L308.6,0" stroke-width="1.33333" fill="none"/><path stroke="#118972" d="M313.7,0L307.7,-3.5C308.3,-2.4,308.6,-1.3,308.6,0C308.6,1.3,308.3,2.4,307.7,3.5L313.7,0" stroke-width="1" stroke-linecap="round" fill="#118972"/></g><g id="shape10" transform="matrix(-0.98,0.21,-0.21,-0.98,318,213)"><path stroke="#236ea1" d="M0,0L317,0" stroke-width="1.33333" fill="none"/><path stroke="#236ea1" d="M322,0L316,-3.5C316.6,-2.4,317,-1.3,317,0C317,1.3,316.6,2.4,316,3.5L322,0" stroke-width="1" stroke-linecap="round" fill="#236ea1"/></g></g><g id="shape11"><text class="st5"><tspan y="17" x="15">客户</tspan></text></g><g id="shape12" transform="translate(318,0)"><text class="st5"><tspan y="17" x="7">服务器</tspan></text></g></g><g id="shape13" transform="translate(0,46)"><text class="st6"><tspan y="18" x="69">socket</tspan><tspan y="37" x="13">connect(阻塞)</tspan><tspan y="56" x="45">(主动打开)</tspan></text></g><g id="shape14" transform="translate(10,297)"><text class="st5"><tspan y="21" x="9">connect返回</tspan></text></g><g id="shape15" transform="translate(466,41)"><text class="st7"><tspan y="18" x="4">socket,bind,listen</tspan><tspan y="37" x="4">（被动打开）</tspan><tspan y="56" x="4">accept(阻塞)</tspan></text></g><g id="shape16" transform="translate(466,211)"><text class="st7"><tspan y="25.5" x="10">accept返回</tspan><tspan y="44.5" x="12">read(阻塞)</tspan></text></g></g><g id="shape17" transform="matrix(0.99,0.13,-0.13,0.99,260,71.5)"><text class="st5"><tspan y="17.8" x="7">INIT(Ta,j)</tspan></text></g><g id="shape18" transform="matrix(0.99,-0.16,0.16,0.99,167.7,155.5)"><text class="st7"><tspan y="15.7" x="5">Ta:INIT ACK(Tz,K,cookie C)</tspan></text></g><g id="shape19" transform="matrix(0.99,0.12,-0.12,0.99,194.2,180.5)"><text class="st5"><tspan y="15.8" x="29.5">Tz:COOKIE ECHO C</tspan></text></g><g id="shape20" transform="matrix(0.98,-0.21,0.21,0.98,176.1,281.1)"><text class="st7"><tspan y="17" x="53">Ta:COOKIE ACK</tspan></text></g></g><g id="shape21" transform="translate(74.26,536.85)"><text class="st7"><tspan y="18" x="4">SCTP的四路握手在很多方面类似于TCP的三路握手，差别主要在于作为SCTP整体一部分的cookie的生成。INIT承载一个验证标记Ta和</tspan><tspan y="37" x="4">一个初始序列号j。在关联的有效期内，验证标记Ta必须在对端发送的每个分组中出现。初始序号j用作承载用户数据的DATA块的其实序列</tspan><tspan y="56" x="4">号。对端也在INIT ACK中承载一个验证标记Tz，在关联的有效期内，验证标记Tz也必须在其发送的每个分组中出现。除了验证标记Tz和</tspan><tspan y="75" x="4">初始序列号K外，INIT的接受端还在作为响应的INIT ACK中提供一个cookie C。该cookie包含设置本SCTP关联所需的所有状态，这样服</tspan><tspan y="94" x="4">务器的SCTP栈就不必保存所关联客户的有关信息。</tspan><tspan y="113" x="4">四路握手结束时，两段各自选择一个猪目的地址，当不存在网络故障时，主目的地址将用作数据要发送到的默认目的地址</tspan></text></g></g></svg>